#!/bin/bash

set -u

# Luarocks installs these
MOONSCRIPT_VERSION=${MOONSCRIPT_VERSION:-0.2.6}
LAPIS_VERSION=${LAPIS_VERSION:-1.0.4}

version=${OPENRESTY_VERSION:-1.7.2.1}

LAPIS_USR_DIR=$OPENSHIFT_LAPIS_DIR/usr/${version}
LUA_PATH="$LAPIS_USR_DIR/share/lua/5.1/?.lua;$LAPIS_USR_DIR/lualib/?.lua;$OPENSHIFT_DEPENDENCIES_DIR/share/lua/5.1/?.lua;;"
LUA_CPATH="$LAPIS_USR_DIR/lualib/?.so;$OPENSHIFT_DEPENDENCIES_DIR/lib/lua/5.1/?.so;;;"
LUAROCKS_CONFIG="$OPENSHIFT_DEPENDENCIES_DIR/luarocks-config.lua"

echo "$version" > $OPENSHIFT_LAPIS_DIR/env/OPENRESTY_VERSION
echo "$LUA_PATH" > $OPENSHIFT_LAPIS_DIR/env/LUA_PATH
echo "$LUA_CPATH" > $OPENSHIFT_LAPIS_DIR/env/LUA_CPATH
echo "$LUAROCKS_CONFIG" > $OPENSHIFT_LAPIS_DIR/env/LUAROCKS_CONFIG
echo "$LAPIS_USR_DIR/bin/luarocks" > $OPENSHIFT_LAPIS_DIR/env/LUAROCKS
echo "$OPENSHIFT_DEPENDENCIES_DIR/bin/moonc" > $OPENSHIFT_LAPIS_DIR/env/MOONC
echo "$OPENSHIFT_DEPENDENCIES_DIR/bin/moon" > $OPENSHIFT_LAPIS_DIR/env/MOON
echo "$OPENSHIFT_DEPENDENCIES_DIR/bin/lapis" > $OPENSHIFT_LAPIS_DIR/env/LAPIS

# Update the luarocks config for the current application
luarocks_config "$OPENSHIFT_DEPENDENCIES_DIR/luarocks-config.lua" "$OPENSHIFT_DEPENDENCIES_DIR"

$LAPIS_USR_DIR/bin/luarocks install moonscript $MOONSCRIPT_VERSION
$LAPIS_USR_DIR/bin/luarocks install lapis $LAPIS_VERSION

for dir in logs run; do
	mkdir -p $OPENSHIFT_LAPIS_DIR/$dir
done
